---
const { site } = Astro.props;
const work = site.work ?? [];
const workSectionLabel = site.workSectionLabel ?? "Ausgewählte Arbeiten";
const workHeading = site.workHeading ?? "Aktuelle Projekte.";
const workSwipeHint = site.workSwipeHint ?? "Wischen zum Entdecken →";
---

<section id="work" class="bg-[#FDFBF7] py-24" aria-labelledby="work-heading">
  <div class="mx-auto max-w-7xl px-6">
    <div class="mb-16">
      <span class="mb-2 block text-sm font-semibold uppercase tracking-wider text-zinc-500">{workSectionLabel}</span>
      <h2 id="work-heading" class="font-display text-4xl italic text-zinc-900 md:text-5xl">{workHeading}</h2>
    </div>
    <div class="relative md:static">
      <p class="mb-3 text-xs font-medium text-zinc-400 sm:hidden" aria-hidden="true">{workSwipeHint}</p>
      <div class="relative -mx-[10px] overflow-x-auto snap-x snap-mandatory scroll-smooth touch-pan-x px-[10px] scroll-pl-[10px] scroll-pr-[10px] md:mx-0 md:overflow-visible md:px-0" data-work-scroller>
        <div class="flex gap-6 pb-4 pr-0 md:pr-0 md:gap-8 lg:gap-10 md:justify-center md:flex-wrap">
        {work.map((item) => {
          const imgSrc = (item.image && String(item.image).trim()) || "";
          return (
          <article class="group w-[88vw] min-w-[300px] shrink-0 snap-start md:w-[340px] md:shrink-0 lg:w-[340px]" data-work-card>
            <div class="rounded-2xl focus-within:ring-2 focus-within:ring-zinc-400 focus-within:ring-offset-2">
              <div class="relative mb-5">
                <div
                  class="work-preview-scroll aspect-[16/10] min-h-0 overflow-x-hidden overflow-y-auto rounded-2xl overscroll-contain scroll-smooth [scrollbar-gutter:stable] [-webkit-overflow-scrolling:touch] focus:outline-none focus:ring-2 focus:ring-zinc-400 focus:ring-offset-2"
                  data-work-image-scroll
                  tabindex="0"
                  aria-label={`Project screenshot preview: ${item.title}`}
                >
                  {imgSrc ? (
                    <img
                      src={imgSrc}
                      alt={`Screenshot: ${item.title}`}
                      width="800"
                      loading="lazy"
                      decoding="async"
                      class="block w-full h-auto"
                    />
                  ) : (
                    <div class="h-full min-h-[200px] w-full rounded-2xl bg-zinc-200" aria-hidden="true" />
                  )}
                </div>
              </div>
              <a href={item.href} class="block focus:outline-none focus:ring-2 focus:ring-zinc-400 focus:ring-offset-2 rounded-2xl">
                <div class="flex items-start justify-between">
                  <div>
                    <h3 class="mb-1 text-2xl font-bold text-zinc-900 decoration-zinc-900 underline-offset-4 group-hover:underline decoration-1">{item.title}</h3>
                    <p class="text-sm text-zinc-500">{item.tags?.join(", ") ?? ""}</p>
                  </div>
                  <span class="text-zinc-400 transition-transform group-hover:translate-x-1" aria-hidden="true">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                  </span>
                </div>
              </a>
            </div>
          </article>
        );})}
        <span class="w-[10px] shrink-0 md:hidden" aria-hidden="true"></span>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  (function () {
    const mediaQuery = window.matchMedia("(max-width: 640px)");
    let initialized = false;

    function tryInit() {
      if (mediaQuery.matches && !initialized) {
        init();
        initialized = true;
      }
    }

    function init() {
      const scroller = document.querySelector("[data-work-scroller]");
      const container = scroller?.firstElementChild;
      const cards = container ? container.querySelectorAll("[data-work-card]") : [];
      if (!scroller || !container || !cards.length) return;

      requestAnimationFrame(function () {
        scroller.scrollLeft = 0;
      });

      let mouseGesture = null;

      function onMouseMove(e) {
        if (!mouseGesture) return;
        const x = e.clientX;
        const y = e.clientY;
        if (mouseGesture.intent === null) {
          const dx = x - mouseGesture.startX;
          const dy = y - mouseGesture.startY;
          if (Math.abs(dx) > 10 || Math.abs(dy) > 10) {
            mouseGesture.intent = Math.abs(dx) > Math.abs(dy) ? "horizontal" : "vertical";
          }
        }
        if (mouseGesture.intent === "horizontal") {
          e.preventDefault();
          const delta = x - mouseGesture.lastX;
          scroller.scrollBy({ left: -delta, behavior: "auto" });
          mouseGesture.lastX = x;
        }
      }

      function onMouseUp() {
        mouseGesture = null;
        document.removeEventListener("mousemove", onMouseMove);
        document.removeEventListener("mouseup", onMouseUp);
      }

      scroller.addEventListener("mousedown", function (e) {
        if (e.button !== 0) return;
        mouseGesture = { startX: e.clientX, startY: e.clientY, lastX: e.clientX, intent: null };
        document.addEventListener("mousemove", onMouseMove);
        document.addEventListener("mouseup", onMouseUp);
      }, { passive: false });
    }

    mediaQuery.addEventListener("change", tryInit);
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", tryInit);
    } else {
      tryInit();
    }
  })();
</script>

<style>
  /* Internal scroll: natural image height inside fixed aspect box (override global #work aspect img) */
  :global(#work) .work-preview-scroll img {
    height: auto !important;
    object-fit: unset;
    object-position: unset;
  }

  /* Mobile: don't make image area a scroll container so horizontal swipes on the image scroll the carousel */
  @media (max-width: 640px) {
    :global(#work) .work-preview-scroll {
      overflow: hidden;
      touch-action: pan-x;
    }
    /* Hide horizontal scrollbar so only padding is visible, no grey bar before end of carousel */
    :global(#work) [data-work-scroller] {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    :global(#work) [data-work-scroller]::-webkit-scrollbar {
      display: none;
    }
  }

  /* Match light mode viewport in dark mode: global.css applies inset clip-path to .dark #work [class*="aspect-"], which shrinks the visible area; reset so only colors differ */
  @media (min-width: 768px) {
    :global(.dark) :global(#work) .work-preview-scroll {
      clip-path: none;
      -webkit-clip-path: none;
    }
  }
</style>
